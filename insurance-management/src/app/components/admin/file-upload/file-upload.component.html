<app-navigation></app-navigation>

<div class="card px-5 py-5">
  <div class="row mb-4">
    <div class="col-md-8">
      <h4 class="card-title">
        <mat-icon>cloud_upload</mat-icon>
        Bulk Data Import
      </h4>
      <p class="text-muted">Upload Excel or CSV files to import policies and beneficiaries</p>
    </div>
    <div class="col-md-4 text-end">
      <div class="row">
        <div class="col-12 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Entity Type</mat-label>
            <mat-select [(value)]="entityType" (selectionChange)="onEntityTypeChange()">
              <mat-option value="policy">Policies</mat-option>
              <mat-option value="beneficiary">Beneficiaries</mat-option>
              <mat-option value="combined">Combined (Policyholder + Policy + Beneficiary)</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-12" *ngIf="entityType === 'policy' || entityType === 'combined'">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Company</mat-label>
            <mat-select [(value)]="selectedCompanyId" required>
              <mat-option value="">Select Company</mat-option>
              <mat-option *ngFor="let company of companies" [value]="company.id">
                {{ company.name }}
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="companies.length === 0">No companies available. <a href="/admin/companies">Add companies</a> first.</mat-hint>
          </mat-form-field>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Tabs -->
  <mat-tab-group [(selectedIndex)]="currentStep" class="mb-4">
    <mat-tab label="Upload File">
      <div class="tab-content p-4">
        <!-- File Upload Section -->
        <div class="upload-section mb-4">
          <div class="file-drop-zone"
               [class.drag-over]="isDragOver"
               [class.has-file]="selectedFile"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onDrop($event)">

            <div *ngIf="!selectedFile" class="upload-prompt">
              <mat-icon class="upload-icon">cloud_upload</mat-icon>
              <h5>Drag and drop your file here</h5>
              <p class="text-muted">or click to select a file</p>
              <p class="text-muted small">Supported formats: .xlsx, .xls, .csv (Max: 10MB)</p>

              <input type="file"
                     #fileInput
                     (change)="onFileSelected($event)"
                     accept=".xlsx,.xls,.csv"
                     hidden>
              <button mat-raised-button color="primary" (click)="fileInput.click()">
                Select File
              </button>
            </div>

            <div *ngIf="selectedFile" class="file-info">
              <mat-icon class="file-icon">description</mat-icon>
              <div class="file-details">
                <h6>{{ selectedFile.name }}</h6>
                <p class="text-muted small">{{ formatFileSize(selectedFile.size) }}</p>
              </div>
              <button mat-icon-button (click)="removeFile()" color="warn">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button mat-raised-button
                  color="primary"
                  [disabled]="!canProceedToMapping() || isProcessing"
                  (click)="goToStep(1)">
            Next: Map Columns
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Map Columns" [disabled]="!canProceedToMapping()">
      <div class="tab-content p-4">
        <!-- Template Management -->
        <div class="template-section mb-4">
          <div class="row">
            <div class="col-md-4">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Load Template</mat-label>
                <mat-select [(value)]="selectedTemplate" (selectionChange)="loadTemplate()">
                  <mat-option value="">-- Select Template --</mat-option>
                  <mat-option *ngFor="let template of savedTemplates" [value]="template.name">
                    {{ template.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="col-md-3">
              <button mat-raised-button color="accent" (click)="autoMapColumns()" class="me-2">
                <mat-icon>auto_fix_high</mat-icon>
                Auto Map
              </button>
            </div>
            <div class="col-md-5">
              <div class="input-group">
                <mat-form-field appearance="outline" class="flex-grow-1">
                  <mat-label>Template Name</mat-label>
                  <input matInput [(ngModel)]="newTemplateName" placeholder="Enter template name">
                </mat-form-field>
                <button mat-raised-button (click)="saveTemplate()" class="ms-2">
                  <mat-icon>save</mat-icon>
                  Save Template
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Column Mapping Table -->
        <div class="mapping-section mb-4">
          <table mat-table [dataSource]="headerMappingData" class="w-100 mat-elevation-z1">
            <!-- File Column -->
            <ng-container matColumnDef="fileColumn">
              <th mat-header-cell *matHeaderCellDef>File Column</th>
              <td mat-cell *matCellDef="let element">
                <strong>{{ element.header }}</strong>
                <br>
                <small class="text-muted">Sample: {{ element.sampleData }}</small>
              </td>
            </ng-container>

            <!-- System Field -->
            <ng-container matColumnDef="systemField">
              <th mat-header-cell *matHeaderCellDef>Maps To</th>
              <td mat-cell *matCellDef="let element">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-select [(value)]="columnMapping[element.header]">
                    <mat-option value="">-- No Mapping --</mat-option>
                    <mat-option *ngFor="let field of getAvailableFields()" [value]="field">
                      {{ formatFieldName(field) }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </td>
            </ng-container>

            <!-- Sample Data -->
            <ng-container matColumnDef="sample">
              <th mat-header-cell *matHeaderCellDef>Preview</th>
              <td mat-cell *matCellDef="let element">
                <span *ngIf="columnMapping[element.header]" class="preview-chip">
                  <mat-icon class="small-icon">check_circle</mat-icon>
                  {{ formatFieldName(columnMapping[element.header]) }}
                </span>
                <span *ngIf="!columnMapping[element.header]" class="text-muted">Not mapped</span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="mappingColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: mappingColumns;"></tr>
          </table>
        </div>

        <div class="d-flex justify-content-between">
          <button mat-stroked-button (click)="goToStep(0)">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button
                  color="primary"
                  [disabled]="!canProceedToValidation()"
                  (click)="goToStep(2)">
            Next: Validate Data
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Validate & Upload" [disabled]="!canProceedToValidation()">
      <div class="tab-content p-4">
        <!-- Validation Summary -->
        <div class="validation-summary mb-4">
          <div class="row">
            <div class="col-md-4">
              <div class="stat-card success" *ngIf="getErrorCount() === 0">
                <mat-icon>check_circle</mat-icon>
                <div>
                  <h5>{{ getValidRowCount() }}</h5>
                  <span>Valid Rows</span>
                </div>
              </div>
            </div>
            <div class="col-md-4" *ngIf="getErrorCount() > 0">
              <div class="stat-card error">
                <mat-icon>error</mat-icon>
                <div>
                  <h5>{{ getErrorCount() }}</h5>
                  <span>Errors</span>
                </div>
              </div>
            </div>
            <div class="col-md-4" *ngIf="getWarningCount() > 0">
              <div class="stat-card warning">
                <mat-icon>warning</mat-icon>
                <div>
                  <h5>{{ getWarningCount() }}</h5>
                  <span>Warnings</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Error List -->
        <div *ngIf="validationErrors.length > 0" class="error-section mb-4">
          <h6>Validation Issues</h6>
          <mat-expansion-panel *ngFor="let error of validationErrors; let i = index" class="mb-2">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon [color]="error.severity === 'error' ? 'warn' : 'accent'" class="me-2">
                  {{ error.severity === 'error' ? 'error' : 'warning' }}
                </mat-icon>
                Row {{ error.row }}: {{ formatFieldName(error.field) }}
              </mat-panel-title>
              <mat-panel-description>
                {{ error.message }}
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="error-details">
              <pre>{{ rawData[error.row - 1] | json }}</pre>
            </div>
          </mat-expansion-panel>
        </div>

        <!-- Data Preview -->
        <div class="preview-section mb-4" *ngIf="previewData.length > 0">
          <h6>Data Preview (First 10 rows)</h6>
          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead class="table-light">
                <tr>
                  <th *ngFor="let field of getMappedFields()">{{ formatFieldName(field) }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of previewData">
                  <td *ngFor="let field of getMappedFields()">{{ row[field] || '-' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <button mat-stroked-button (click)="goToStep(1)">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <div>
            <button mat-raised-button
                    color="primary"
                    [disabled]="getErrorCount() > 0 || isProcessing"
                    (click)="uploadData()">
              <mat-icon>cloud_upload</mat-icon>
              Upload {{ getValidRowCount() }} Records
            </button>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Loading Overlay -->
  <div *ngIf="isProcessing" class="loading-overlay">
    <div class="loading-content">
      <mat-icon class="loading-spinner">hourglass_empty</mat-icon>
      <p>Processing...</p>
    </div>
  </div>
</div>